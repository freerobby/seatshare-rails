<div class="panel panel-default">
  <div class="panel-heading">
    Your <strong><%= @group.entity.entity_name %></strong> group is administered by <%= link_to @group.administrators.first.full_name, {:controller => 'profiles', :action => 'show', :id => @group.administrators.first.id } %>
    <div class="pull-right">
      <%= link_to raw('<span class="glyphicon glyphicon-cog"></span> Edit Settings'), { :controller => 'groups', :action => 'edit', :id => @group.id }, :class => 'btn btn-xs btn-default' %>
    </div>
  </div>
  <div id="collapseOne" class="panel-collapse collapse">
    <div class="panel-body">
    </div>
  </div>
</div>

<% if !@events.blank? %>

<% for event in @events %>

<% tickets = event.tickets(@group) %>
<% ticket_stats = event.ticket_stats(@group, current_user) %>

<% if @events.first === event %>
<div class="panel panel-primary">
  <div class="panel-heading">
    <span class="glyphicon glyphicon-calendar"></span> <%= event.date_time %>
  </div>
  <div class="panel-body">
    <h2><%= link_to event.event_name, :controller => 'events', :action => 'show', :group_id => @group.id, :id => event.id %></h2>
    <p><%= event.description %></p>
    <% if ticket_stats[:available] > 0 %>
    <p class="lead"><strong>There are tickets available for this event!</strong><br />Click on a ticket below to send a request.</p>
    <% else %>
    <p class="lead"><strong>No tickets are available right now.</strong><br />You can contact ticket holders to make sure they are still going.</p>
    <% end %>

    <div class="progress">
      <div class="progress-bar progress-bar-success" role="progressbar" style="width:<%= ticket_stats[:percent_full] %>%"></div>
    </div>

    <% if ticket_stats[:available] > 0 %>
    <table class="table">
      <tbody>
        <% for ticket in tickets %>
        <% next if ticket.is_assigned? %>
        <tr>
          <td>
            <%= link_to ticket.section_row_seat, :controller => 'tickets', :action => 'edit', :group_id => @group.id, :event_id => event.id, :id => ticket.id %>
            <% if ticket.note? %>
            <span data-toggle="tooltip" title="<%= ticket.note %>" class="glyphicon glyphicon-comment"></span>
            <% end %>
            <% if ticket.ticket_files.count > 0 %>
            <span data-toggle="tooltip" title="Attachments" class="glyphicon glyphicon-paperclip"></span>
            <% end %>
          </td>
          <td>via <%= ticket.owner.full_name %></td>
          <td class="text-right">
            <%= link_to number_to_currency(ticket.cost), { :controller => 'tickets', :action => 'edit', :group_id => @group.id, :event_id => event.id, :id => ticket.id }, :class => 'btn btn-primary', :data => {:toggle => 'tooltip' }, :title => 'Request Ticket' %>
          </td>
        </tr>
        <% end %>
      </tbody>
    </table>

    <% end %>
  </div>
</div>

<% else %>

<div class="panel panel-default">
  <div class="panel-heading">
      <% if ticket_stats[:available] > 0 %>
      <div class="pull-right">
        <a href="javascript:void(0)" onclick="$('#tickets-<%= event.id %>').collapse('toggle')" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-list"></span></a>
      </div>
      <% end %>
    <span class="glyphicon glyphicon-calendar"></span> <%= event.date_time %>
  </div>
  <div class="panel-body">
    <div class="row">
      <div class="col-md-7">
        <h3><%= link_to event.event_name, :controller => 'events', :action => 'show', :group_id => @group.id, :id => event.id %></h3>
        <p><%= event.description %></p>
      </div>
      <div class="col-md-5">
        <div class="progress">
          <div class="progress-bar progress-bar-success" role="progressbar" style="width:<%= ticket_stats[:percent_full] %>%"></div>
        </div>
        <ul class="list-unstyled">
          <li><span class="badge"><%= ticket_stats[:available] %></span> available in the group</li>
          <li><span class="badge"><%= ticket_stats[:total] %></span> total in the group</li>
          <li><span class="badge"><%= ticket_stats[:held] %></span> held by you</li>
        </ul>
      </div>
    </div>
    
    <div id="tickets-<%= event.id %>" class="collapse">
      <table class="table">
        <tbody>
          <% for ticket in tickets %>
          <% next if ticket.is_assigned? %>
          <tr>
            <td>
              <%= link_to ticket.section_row_seat, :controller => 'tickets', :action => 'edit', :group_id => @group.id, :event_id => event.id, :id => ticket.id %>
              <% if ticket.note? %>
              <span data-toggle="tooltip" title="<%= ticket.note %>" class="glyphicon glyphicon-comment"></span>
              <% end %>
              <% if ticket.ticket_files.count > 0 %>
              <span data-toggle="tooltip" title="Attachments" class="glyphicon glyphicon-paperclip"></span>
              <% end %>
            </td>
            <td>via <%= ticket.owner.full_name %></td>
            <td class="text-right">
              <%= link_to number_to_currency(ticket.cost), { :controller => 'tickets', :action => 'edit', :group_id => @group.id, :event_id => event.id, :id => ticket.id }, :class => 'btn btn-primary', :data => {:toggle => 'tooltip' }, :title => 'Request Ticket' %>
            </td>
          </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>
<% end %>

<% end %>

<% else %>

<div class="alert alert-info">
  <p>
    There are no events available right now. Please check back later.
  </p>
</div>

<% end %>

<% content_for :sidebar do %>

<% if @events.count > 0 %>

<div class="well text-center">
  <ul class="list-inline" style="margin-bottom:0;">
    <li>Have tickets to share?</li>
    <li><%= link_to raw('<span class="glyphicon glyphicon-calendar"></span> Add Tickets'), { :controller => 'tickets', :action => 'new', :group_id => @group.id }, :class => 'btn btn-default btn-sm' %></li>
  </ul>
</div>

<fieldset>
  <legend>Calendar</legend>
  <div id="sidebar_calendar"></div>
  <script>
    $.get('/groups/<%= @group.id %>/events_feed', function(result) {
      $('#sidebar_calendar').clndr({
        daysOfTheWeek: ['S', 'M', 'T', 'W', 'T', 'F', 'S'],
        numberOfRows: 5,
        events: result,
        clickEvents: {
          click: function(target) {
            if (!_.isObject(target.events) || _.isEmpty(target.events[0])) {
              return false;
            }
            window.location = target.events[0].url;
          }
        },
        showAdjacentMonths: true,
        adjacentDaysChangeMonth: true
      });
    });
  </script>
</fieldset>

<% end %>

<fieldset>
  <legend>Group members</legend>

<ul class="list-unstyled group-members">
  <% for member in @group.members %>
  <li><%= image_tag member.gravatar %> <%= link_to member.full_name, {:controller => 'profiles', :action => 'show', :id => member.id } %></li>
  <% end %>
  <li class="text-right"><%= link_to raw('<span class="glyphicon glyphicon-plus"></span> Invite Member'), { :controller => 'groups', :action => 'invite', :id => @group.id }, :class => 'btn btn-default btn-sm' %></li>
</ul>

</fieldset>

<% end %>